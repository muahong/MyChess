(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();function ns(o){return o!==null?{comment:o,variations:[]}:{variations:[]}}function os(o,t,e,s,i){const r={move:o,variations:i};return t&&(r.suffix=t),e&&(r.nag=e),s!==null&&(r.comment=s),r}function as(...o){const[t,...e]=o;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function ls(o,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:o,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function fs(o,t){function e(){this.constructor=o}e.prototype=t.prototype,o.prototype=new e}function V(o,t,e,s){var i=Error.call(this,o);return Object.setPrototypeOf&&Object.setPrototypeOf(i,V.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}fs(V,Error);function _e(o,t,e){return e=e||" ",o.length>t?o:(t-=o.length,e+=e.repeat(t),o+e.slice(0,t))}V.prototype.format=function(o){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<o.length;s++)if(o[s].source===this.location.source){e=o[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,h=this.location.source+":"+r.line+":"+r.column;if(e){var c=this.location.end,u=_e("",r.line.toString().length," "),_=e[i.line-1],g=i.line===c.line?c.column:_.length+1,S=g-i.column||1;t+=`
 --> `+h+`
`+u+` |
`+r.line+" | "+_+`
`+u+" | "+_e("",i.column-1," ")+_e("",S,"^")}else t+=`
 at `+h}return t};V.buildMessage=function(o,t){var e={literal:function(_){return'"'+i(_.text)+'"'},class:function(_){var g=_.parts.map(function(S){return Array.isArray(S)?r(S[0])+"-"+r(S[1]):r(S)});return"["+(_.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(_){return _.description}};function s(_){return _.charCodeAt(0).toString(16).toUpperCase()}function i(_){return _.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function r(_){return _.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+s(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+s(g)})}function h(_){return e[_.type](_)}function c(_){var g=_.map(h),S,d;if(g.sort(),g.length>0){for(S=1,d=1;S<g.length;S++)g[S-1]!==g[S]&&(g[d]=g[S],d++);g.length=d}switch(g.length){case 1:return g[0];case 2:return g[0]+" or "+g[1];default:return g.slice(0,-1).join(", ")+", or "+g[g.length-1]}}function u(_){return _?'"'+i(_)+'"':"end of input"}return"Expected "+c(o)+" but "+u(t)+" found."};function hs(o,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:je},r=je,h="[",c='"',u="]",_=".",g="O-O-O",S="O-O",d="0-0-0",E="0-0",y="$",$="{",F="}",he=";",ce="(",it=")",Ae="1-0",$e="0-1",we="1/2-1/2",rt="*",ue=/^[a-zA-Z]/,Ie=/^[^"]/,ee=/^[0-9]/,Te=/^[.]/,Pe=/^[a-zA-Z1-8\-=]/,nt=/^[+#]/,Ne=/^[!?]/,Me=/^[^}]/,Oe=/^[^\r\n]/,xe=/^[ \t\r\n]/,ot=q("tag pair"),at=T("[",!1),Le=T('"',!1),lt=T("]",!1),ft=q("tag name"),pe=R([["a","z"],["A","Z"]],!1,!1),ht=q("tag value"),qe=R(['"'],!0,!1),ct=q("move number"),te=R([["0","9"]],!1,!1),ut=T(".",!1),Ke=R(["."],!1,!1),pt=q("standard algebraic notation"),dt=T("O-O-O",!1),_t=T("O-O",!1),gt=T("0-0-0",!1),mt=T("0-0",!1),Re=R([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),vt=R(["+","#"],!1,!1),bt=q("suffix annotation"),Fe=R(["!","?"],!1,!1),Et=q("NAG"),Ct=T("$",!1),kt=q("brace comment"),St=T("{",!1),De=R(["}"],!0,!1),yt=T("}",!1),At=q("rest of line comment"),$t=T(";",!1),Ue=R(["\r",`
`],!0,!1),wt=q("variation"),It=T("(",!1),Tt=T(")",!1),Pt=q("game termination marker"),Nt=T("1-0",!1),Mt=T("0-1",!1),Ot=T("1/2-1/2",!1),xt=T("*",!1),Lt=q("whitespace"),Be=R([" ","	","\r",`
`],!1,!1),qt=function(n,l){return ls(n,l)},Kt=function(n){return Object.fromEntries(n)},Rt=function(n,l){return[n,l]},Ft=function(n,l){return{root:n,marker:l}},Dt=function(n,l){return as(ns(n),...l.flat())},Ut=function(n,l,f,v,b){return os(n,l,f,v,b)},Bt=function(n){return n},Qt=function(n){return n.replace(/[\r\n]+/g," ")},Ht=function(n){return n.trim()},jt=function(n){return n},Gt=function(n,l){return{result:n,comment:l}},a=t.peg$currPos|0,G=[{line:1,column:1}],K=a,se=t.peg$maxFailExpected||[],p=t.peg$silentFails|0,W;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');r=i[t.startRule]}function T(n,l){return{type:"literal",text:n,ignoreCase:l}}function R(n,l,f){return{type:"class",parts:n,inverted:l,ignoreCase:f}}function Vt(){return{type:"end"}}function q(n){return{type:"other",description:n}}function Qe(n){var l=G[n],f;if(l)return l;if(n>=G.length)f=G.length-1;else for(f=n;!G[--f];);for(l=G[f],l={line:l.line,column:l.column};f<n;)o.charCodeAt(f)===10?(l.line++,l.column=1):l.column++,f++;return G[n]=l,l}function He(n,l,f){var v=Qe(n),b=Qe(l),A={source:s,start:{offset:n,line:v.line,column:v.column},end:{offset:l,line:b.line,column:b.column}};return A}function m(n){a<K||(a>K&&(K=a,se=[]),se.push(n))}function Wt(n,l,f){return new V(V.buildMessage(n,l),n,l,f)}function je(){var n,l,f;return n=a,l=Yt(),f=Jt(),n=qt(l,f),n}function Yt(){var n,l,f;for(n=a,l=[],f=Ge();f!==e;)l.push(f),f=Ge();return f=x(),n=Kt(l),n}function Ge(){var n,l,f,v,b,A,Q;return p++,n=a,x(),o.charCodeAt(a)===91?(l=h,a++):(l=e,p===0&&m(at)),l!==e?(x(),f=zt(),f!==e?(x(),o.charCodeAt(a)===34?(v=c,a++):(v=e,p===0&&m(Le)),v!==e?(b=Zt(),o.charCodeAt(a)===34?(A=c,a++):(A=e,p===0&&m(Le)),A!==e?(x(),o.charCodeAt(a)===93?(Q=u,a++):(Q=e,p===0&&m(lt)),Q!==e?n=Rt(f,b):(a=n,n=e)):(a=n,n=e)):(a=n,n=e)):(a=n,n=e)):(a=n,n=e),p--,n===e&&p===0&&m(ot),n}function zt(){var n,l,f;if(p++,n=a,l=[],f=o.charAt(a),ue.test(f)?a++:(f=e,p===0&&m(pe)),f!==e)for(;f!==e;)l.push(f),f=o.charAt(a),ue.test(f)?a++:(f=e,p===0&&m(pe));else l=e;return l!==e?n=o.substring(n,a):n=l,p--,n===e&&(l=e,p===0&&m(ft)),n}function Zt(){var n,l,f;for(p++,n=a,l=[],f=o.charAt(a),Ie.test(f)?a++:(f=e,p===0&&m(qe));f!==e;)l.push(f),f=o.charAt(a),Ie.test(f)?a++:(f=e,p===0&&m(qe));return n=o.substring(n,a),p--,l=e,p===0&&m(ht),n}function Jt(){var n,l,f;return n=a,l=Ve(),x(),f=rs(),f===e&&(f=null),x(),n=Ft(l,f),n}function Ve(){var n,l,f,v;for(n=a,l=de(),l===e&&(l=null),f=[],v=We();v!==e;)f.push(v),v=We();return n=Dt(l,f),n}function We(){var n,l,f,v,b,A,Q,ie;if(n=a,x(),Xt(),x(),l=es(),l!==e){for(f=ts(),f===e&&(f=null),v=[],b=Ye();b!==e;)v.push(b),b=Ye();for(b=x(),A=de(),A===e&&(A=null),Q=[],ie=ze();ie!==e;)Q.push(ie),ie=ze();n=Ut(l,f,v,A,Q)}else a=n,n=e;return n}function Xt(){var n,l,f,v,b,A;for(p++,n=a,l=[],f=o.charAt(a),ee.test(f)?a++:(f=e,p===0&&m(te));f!==e;)l.push(f),f=o.charAt(a),ee.test(f)?a++:(f=e,p===0&&m(te));if(o.charCodeAt(a)===46?(f=_,a++):(f=e,p===0&&m(ut)),f!==e){for(v=x(),b=[],A=o.charAt(a),Te.test(A)?a++:(A=e,p===0&&m(Ke));A!==e;)b.push(A),A=o.charAt(a),Te.test(A)?a++:(A=e,p===0&&m(Ke));l=[l,f,v,b],n=l}else a=n,n=e;return p--,n===e&&(l=e,p===0&&m(ct)),n}function es(){var n,l,f,v,b,A;if(p++,n=a,l=a,o.substr(a,5)===g?(f=g,a+=5):(f=e,p===0&&m(dt)),f===e&&(o.substr(a,3)===S?(f=S,a+=3):(f=e,p===0&&m(_t)),f===e&&(o.substr(a,5)===d?(f=d,a+=5):(f=e,p===0&&m(gt)),f===e&&(o.substr(a,3)===E?(f=E,a+=3):(f=e,p===0&&m(mt)),f===e))))if(f=a,v=o.charAt(a),ue.test(v)?a++:(v=e,p===0&&m(pe)),v!==e){if(b=[],A=o.charAt(a),Pe.test(A)?a++:(A=e,p===0&&m(Re)),A!==e)for(;A!==e;)b.push(A),A=o.charAt(a),Pe.test(A)?a++:(A=e,p===0&&m(Re));else b=e;b!==e?(v=[v,b],f=v):(a=f,f=e)}else a=f,f=e;return f!==e?(v=o.charAt(a),nt.test(v)?a++:(v=e,p===0&&m(vt)),v===e&&(v=null),f=[f,v],l=f):(a=l,l=e),l!==e?n=o.substring(n,a):n=l,p--,n===e&&(l=e,p===0&&m(pt)),n}function ts(){var n,l,f;for(p++,n=a,l=[],f=o.charAt(a),Ne.test(f)?a++:(f=e,p===0&&m(Fe));f!==e;)l.push(f),l.length>=2?f=e:(f=o.charAt(a),Ne.test(f)?a++:(f=e,p===0&&m(Fe)));return l.length<1?(a=n,n=e):n=l,p--,n===e&&(l=e,p===0&&m(bt)),n}function Ye(){var n,l,f,v,b;if(p++,n=a,x(),o.charCodeAt(a)===36?(l=y,a++):(l=e,p===0&&m(Ct)),l!==e){if(f=a,v=[],b=o.charAt(a),ee.test(b)?a++:(b=e,p===0&&m(te)),b!==e)for(;b!==e;)v.push(b),b=o.charAt(a),ee.test(b)?a++:(b=e,p===0&&m(te));else v=e;v!==e?f=o.substring(f,a):f=v,f!==e?n=Bt(f):(a=n,n=e)}else a=n,n=e;return p--,n===e&&p===0&&m(Et),n}function de(){var n;return n=ss(),n===e&&(n=is()),n}function ss(){var n,l,f,v,b;if(p++,n=a,o.charCodeAt(a)===123?(l=$,a++):(l=e,p===0&&m(St)),l!==e){for(f=a,v=[],b=o.charAt(a),Me.test(b)?a++:(b=e,p===0&&m(De));b!==e;)v.push(b),b=o.charAt(a),Me.test(b)?a++:(b=e,p===0&&m(De));f=o.substring(f,a),o.charCodeAt(a)===125?(v=F,a++):(v=e,p===0&&m(yt)),v!==e?n=Qt(f):(a=n,n=e)}else a=n,n=e;return p--,n===e&&(l=e,p===0&&m(kt)),n}function is(){var n,l,f,v,b;if(p++,n=a,o.charCodeAt(a)===59?(l=he,a++):(l=e,p===0&&m($t)),l!==e){for(f=a,v=[],b=o.charAt(a),Oe.test(b)?a++:(b=e,p===0&&m(Ue));b!==e;)v.push(b),b=o.charAt(a),Oe.test(b)?a++:(b=e,p===0&&m(Ue));f=o.substring(f,a),n=Ht(f)}else a=n,n=e;return p--,n===e&&(l=e,p===0&&m(At)),n}function ze(){var n,l,f,v;return p++,n=a,x(),o.charCodeAt(a)===40?(l=ce,a++):(l=e,p===0&&m(It)),l!==e?(f=Ve(),f!==e?(x(),o.charCodeAt(a)===41?(v=it,a++):(v=e,p===0&&m(Tt)),v!==e?n=jt(f):(a=n,n=e)):(a=n,n=e)):(a=n,n=e),p--,n===e&&p===0&&m(wt),n}function rs(){var n,l,f;return p++,n=a,o.substr(a,3)===Ae?(l=Ae,a+=3):(l=e,p===0&&m(Nt)),l===e&&(o.substr(a,3)===$e?(l=$e,a+=3):(l=e,p===0&&m(Mt)),l===e&&(o.substr(a,7)===we?(l=we,a+=7):(l=e,p===0&&m(Ot)),l===e&&(o.charCodeAt(a)===42?(l=rt,a++):(l=e,p===0&&m(xt))))),l!==e?(x(),f=de(),f===e&&(f=null),n=Gt(l,f)):(a=n,n=e),p--,n===e&&(l=e,p===0&&m(Pt)),n}function x(){var n,l;for(p++,n=[],l=o.charAt(a),xe.test(l)?a++:(l=e,p===0&&m(Be));l!==e;)n.push(l),l=o.charAt(a),xe.test(l)?a++:(l=e,p===0&&m(Be));return p--,l=e,p===0&&m(Lt),n}if(W=r(),t.peg$library)return{peg$result:W,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:se,peg$maxFailPos:K};if(W!==e&&a===o.length)return W;throw W!==e&&a<o.length&&m(Vt()),Wt(se,K<o.length?o.charAt(K):null,K<o.length?He(K,K+1):He(K,K))}const ae=0xffffffffffffffffn;function ge(o,t){return(o<<t|o>>64n-t)&0xffffffffffffffffn}function Ze(o,t){return o*t&ae}function cs(o){return function(){let t=BigInt(o&ae),e=BigInt(o>>64n&ae);const s=Ze(ge(Ze(t,5n),7n),9n);return e^=t,t=(ge(t,24n)^e^e<<16n)&ae,e=ge(e,37n),o=e<<64n|t,s}}const fe=cs(0xa187eb39cdcaed8f31c4b365b102e01en),us=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>fe()))),ps=Array.from({length:8},()=>fe()),ds=Array.from({length:16},()=>fe()),me=fe(),M="w",L="b",w="p",ke="n",le="b",z="r",B="q",I="k",ve="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class re{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:i,from:r,to:h,flags:c,captured:u,promotion:_}=e,g=P(r),S=P(h);this.color=s,this.piece=i,this.from=g,this.to=S,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=g+S,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const d in k)k[d]&c&&(this.flags+=H[d]);u&&(this.captured=u),_&&(this.promotion=_,this.lan+=_)}isCapture(){return this.flags.indexOf(H.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(H.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(H.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(H.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(H.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(H.BIG_PAWN)>-1}}const N=-1,H={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},k={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Se={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},_s={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},gs={...Se,..._s},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},be={b:[16,32,17,15],w:[-16,-32,-17,-15]},Je={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ms=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],vs=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],bs={p:1,n:2,b:4,r:8,q:16,k:32},Es="pnbrqkPNBRQK",Xe=[ke,le,z,B],Cs=7,ks=6,Ss=1,ys=0,ne={[I]:k.KSIDE_CASTLE,[B]:k.QSIDE_CASTLE},D={w:[{square:C.a1,flag:k.QSIDE_CASTLE},{square:C.h1,flag:k.KSIDE_CASTLE}],b:[{square:C.a8,flag:k.QSIDE_CASTLE},{square:C.h8,flag:k.KSIDE_CASTLE}]},As={b:Ss,w:ks},Ee="--";function j(o){return o>>4}function Z(o){return o&15}function tt(o){return"0123456789".indexOf(o)!==-1}function P(o){const t=Z(o),e=j(o);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function Y(o){return o===M?L:M}function $s(o){const t=o.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let h=0;h<i.length;h++){let c=0,u=!1;for(let _=0;_<i[h].length;_++)if(tt(i[h][_])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};c+=parseInt(i[h][_],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[h][_]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};c+=1,u=!1}if(c!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:h,regex:c}of r){if(!c.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${h} king`};if((t[0].match(c)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${h} kings`}}return Array.from(i[0]+i[7]).some(h=>h.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function ws(o,t){const e=o.from,s=o.to,i=o.piece;let r=0,h=0,c=0;for(let u=0,_=t.length;u<_;u++){const g=t[u].from,S=t[u].to,d=t[u].piece;i===d&&e!==g&&s===S&&(r++,j(e)===j(g)&&h++,Z(e)===Z(g)&&c++)}return r>0?h>0&&c>0?P(e):c>0?P(e).charAt(1):P(e).charAt(0):""}function U(o,t,e,s,i,r=void 0,h=k.NORMAL){const c=j(s);if(i===w&&(c===Cs||c===ys))for(let u=0;u<Xe.length;u++){const _=Xe[u];o.push({color:t,from:e,to:s,piece:i,captured:r,promotion:_,flags:h|k.PROMOTION})}else o.push({color:t,from:e,to:s,piece:i,captured:r,flags:h})}function et(o){let t=o.charAt(0);return t>="a"&&t<="h"?o.match(/[a-h]\d.*[a-h]\d/)?void 0:w:(t=t.toLowerCase(),t==="o"?I:t)}function Ce(o){return o.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Is{_board=new Array(128);_turn=M;_header={};_kings={w:N,b:N};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=ve,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:N,b:N},this._turn=M,this._castling={w:0,b:0},this._epSquare=N,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...gs},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const c=["-","-","0","1"];t=i.concat(c.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:c,error:u}=$s(t);if(!c)throw new Error(u)}const r=i[0];let h=0;this.clear({preserveHeaders:s});for(let c=0;c<r.length;c++){const u=r.charAt(c);if(u==="/")h+=8;else if(tt(u))h+=parseInt(u,10);else{const _=u<"a"?M:L;this._put({type:u.toLowerCase(),color:_},P(h)),h++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=k.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=k.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=k.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=k.QSIDE_CASTLE),this._epSquare=i[3]==="-"?N:C[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let h=C.a8;h<=C.h1;h++){if(this._board[h]){e>0&&(s+=e,e=0);const{color:c,type:u}=this._board[h];s+=c===M?u.toUpperCase():u.toLowerCase()}else e++;h+1&136&&(e>0&&(s+=e),h!==C.h1&&(s+="/"),e=0,h+=8)}let i="";this._castling[M]&k.KSIDE_CASTLE&&(i+="K"),this._castling[M]&k.QSIDE_CASTLE&&(i+="Q"),this._castling[L]&k.KSIDE_CASTLE&&(i+="k"),this._castling[L]&k.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==N)if(t)r=P(this._epSquare);else{const h=this._epSquare+(this._turn===M?16:-16),c=[h+1,h-1];for(const u of c){if(u&136)continue;const _=this._turn;if(this._board[u]?.color===_&&this._board[u]?.type===w){this._makeMove({color:_,from:u,to:this._epSquare,piece:w,captured:w,flags:k.EP_CAPTURE});const g=!this._isKingAttacked(_);if(this._undoMove(),g){r=P(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return us[i][r][t]}_epKey(){return this._epSquare===N?0n:ps[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return ds[t]}_computeHash(){let t=0n;for(let e=C.a8;e<=C.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=me),t}_updateSetup(t){this._history.length>0||(t!==ve?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(ve)}get(t){return this._board[C[t]]}findPiece(t){const e=[];for(let s=C.a8;s<=C.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(P(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(Es.indexOf(t.toLowerCase())===-1||!(s in C))return!1;const i=C[s];if(t==I&&!(this._kings[e]==N||this._kings[e]==i))return!1;const r=this._board[i];return r&&r.type===I&&(this._kings[r.color]=N),this._set(i,{type:t,color:e}),t===I&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(C[t]),e&&e.type===I&&(this._kings[e.color]=N),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[C.e1]?.type===I&&this._board[C.e1]?.color===M,e=this._board[C.e8]?.type===I&&this._board[C.e8]?.color===L;(!t||this._board[C.a1]?.type!==z||this._board[C.a1]?.color!==M)&&(this._castling.w&=-65),(!t||this._board[C.h1]?.type!==z||this._board[C.h1]?.color!==M)&&(this._castling.w&=-33),(!e||this._board[C.a8]?.type!==z||this._board[C.a8]?.color!==L)&&(this._castling.b&=-65),(!e||this._board[C.h8]?.type!==z||this._board[C.h8]?.color!==L)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===N)return;const t=this._epSquare+(this._turn===M?-16:16),e=this._epSquare+(this._turn===M?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==Y(this._turn)||this._board[e]?.type!==w){this._hash^=this._epKey(),this._epSquare=N;return}const i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===w;s.some(i)||(this._hash^=this._epKey(),this._epSquare=N)}_attacked(t,e,s){const i=[];for(let r=C.a8;r<=C.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==t)continue;const h=this._board[r],c=r-e;if(c===0)continue;const u=c+119;if(ms[u]&bs[h.type]){if(h.type===w){if(c>0&&h.color===M||c<=0&&h.color===L)if(s)i.push(P(r));else return!0;continue}if(h.type==="n"||h.type==="k")if(s){i.push(P(r));continue}else return!0;const _=vs[u];let g=r+_,S=!1;for(;g!==e;){if(this._board[g]!=null){S=!0;break}g+=_}if(!S)if(s){i.push(P(r));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(Y(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let r=C.a8;r<=C.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const h=this._board[r];h&&(t[h.type]=h.type in t?t[h.type]+1:1,h.type===le&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[le]===1||t[ke]===1))return!0;if(s===t[le]+2){let r=0;const h=e.length;for(let c=0;c<h;c++)r+=e[c];if(r===0||r===h)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(r=>new re(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,r=e?.toLowerCase(),h=[],c=this._turn,u=Y(c);let _=C.a8,g=C.h1,S=!1;if(i)if(i in C)_=g=C[i],S=!0;else return[];for(let E=_;E<=g;E++){if(E&136){E+=7;continue}if(!this._board[E]||this._board[E].color===u)continue;const{type:y}=this._board[E];let $;if(y===w){if(r&&r!==y)continue;$=E+be[c][0],this._board[$]||(U(h,c,E,$,w),$=E+be[c][1],As[c]===j(E)&&!this._board[$]&&U(h,c,E,$,w,void 0,k.BIG_PAWN));for(let F=2;F<4;F++)$=E+be[c][F],!($&136)&&(this._board[$]?.color===u?U(h,c,E,$,w,this._board[$].type,k.CAPTURE):$===this._epSquare&&U(h,c,E,$,w,w,k.EP_CAPTURE))}else{if(r&&r!==y)continue;for(let F=0,he=Je[y].length;F<he;F++){const ce=Je[y][F];for($=E;$+=ce,!($&136);){if(!this._board[$])U(h,c,E,$,y);else{if(this._board[$].color===c)break;U(h,c,E,$,y,this._board[$].type,k.CAPTURE);break}if(y===ke||y===I)break}}}}if((r===void 0||r===I)&&(!S||g===this._kings[c])){if(this._castling[c]&k.KSIDE_CASTLE){const E=this._kings[c],y=E+2;!this._board[E+1]&&!this._board[y]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,E+1)&&!this._attacked(u,y)&&U(h,c,this._kings[c],y,I,void 0,k.KSIDE_CASTLE)}if(this._castling[c]&k.QSIDE_CASTLE){const E=this._kings[c],y=E-2;!this._board[E-1]&&!this._board[E-2]&&!this._board[E-3]&&!this._attacked(u,this._kings[c])&&!this._attacked(u,E-1)&&!this._attacked(u,y)&&U(h,c,this._kings[c],y,I,void 0,k.QSIDE_CASTLE)}}if(!t||this._kings[c]===-1)return h;const d=[];for(let E=0,y=h.length;E<y;E++)this._makeMove(h[E]),this._isKingAttacked(c)||d.push(h[E]),this._undoMove();return d}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Ee,e);else if(typeof t=="object"){const r=this._moves();for(let h=0,c=r.length;h<c;h++)if(t.from===P(r[h].from)&&t.to===P(r[h].to)&&(!("promotion"in r[h])||t.promotion===r[h].promotion)){s=r[h];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&k.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new re(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=Y(e);if(this._push(t),t.flags&k.NULL_MOVE){e===L&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=N;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&k.EP_CAPTURE&&(this._turn===L?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===I){if(this._kings[e]=t.to,t.flags&k.KSIDE_CASTLE){const i=t.to-1,r=t.to+1;this._movePiece(r,i)}else if(t.flags&k.QSIDE_CASTLE){const i=t.to+1,r=t.to-2;this._movePiece(r,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,r=D[e].length;i<r;i++)if(t.from===D[e][i].square&&this._castling[e]&D[e][i].flag){this._castling[e]^=D[e][i].flag;break}}if(this._castling[s]){for(let i=0,r=D[s].length;i<r;i++)if(t.to===D[s][i].square&&this._castling[s]&D[s][i].flag){this._castling[s]^=D[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&k.BIG_PAWN){let i;e===L?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===w&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===w&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=N}else this._epSquare=N;t.piece===w?this._halfMoves=0:t.flags&(k.CAPTURE|k.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===L&&this._moveNumber++,this._turn=s,this._hash^=me}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new re(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=me;const s=this._turn,i=Y(s);if(e.flags&k.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&k.EP_CAPTURE){let r;s===L?r=e.to-16:r=e.to+16,this._set(r,{type:w,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(k.KSIDE_CASTLE|k.QSIDE_CASTLE)){let r,h;e.flags&k.KSIDE_CASTLE?(r=e.to+1,h=e.to-1):(r=e.to-2,h=e.to+1),this._movePiece(h,r)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const d in this._header)this._header[d]&&s.push(`[${d} "${this._header[d]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const r=d=>{const E=this._comments[this.fen()];if(typeof E<"u"){const y=d.length>0?" ":"";d=`${d}${y}{${E}}`}return d},h=[];for(;this._history.length>0;)h.push(this._undoMove());const c=[];let u="";for(h.length===0&&c.push(r(""));h.length>0;){u=r(u);const d=h.pop();if(!d)break;if(!this._history.length&&d.color==="b"){const E=`${this._moveNumber}. ...`;u=u?`${u} ${E}`:E}else d.color==="w"&&(u.length&&c.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(d,this._moves({legal:!0})),this._makeMove(d)}if(u.length&&c.push(r(u)),c.push(this._header.Result||"*"),e===0)return s.join("")+c.join(" ");const _=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},g=function(d,E){for(const y of E.split(" "))if(y){if(d+y.length>e){for(;_();)d--;s.push(t),d=0}s.push(y),d+=y.length,s.push(" "),d++}return _()&&d--,d};let S=0;for(let d=0;d<c.length;d++){if(S+c[d].length>e&&c[d].includes("{")){S=g(S,c[d]);continue}S+c[d].length>e&&d!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),S=0):d!==0&&(s.push(" "),S++),s.push(c[d]),S+=c[d].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Se[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Se[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=hs(t);this.reset();const r=i.headers;let h="";for(const _ in r)_.toLowerCase()==="fen"&&(h=r[_]),this.header(_,r[_]);if(!e)h&&this.load(h,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let c=i.root;for(;c;){if(c.move){const _=this._moveFromSan(c.move,e);if(_==null)throw new Error(`Invalid move in PGN: ${c.move}`);this._makeMove(_),this._incPositionCount()}c.comment!==void 0&&(this._comments[this.fen()]=c.comment),c=c.variations[0]}const u=i.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&k.KSIDE_CASTLE)s="O-O";else if(t.flags&k.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&k.NULL_MOVE)return Ee;if(t.piece!==w){const i=ws(t,e);s+=t.piece.toUpperCase()+i}t.flags&(k.CAPTURE|k.EP_CAPTURE)&&(t.piece===w&&(s+=P(t.from)[0]),s+="x"),s+=P(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ce(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Ee)return{color:this._turn,from:0,to:0,piece:"k",flags:k.NULL_MOVE};let i=et(s),r=this._moves({legal:!0,piece:i});for(let d=0,E=r.length;d<E;d++)if(s===Ce(this._moveToSan(r[d],r)))return r[d];if(e)return null;let h,c,u,_,g,S=!1;if(c=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),c?(h=c[1],u=c[2],_=c[3],g=c[4],u.length==1&&(S=!0)):(c=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),c&&(h=c[1],u=c[2],_=c[3],g=c[4],u.length==1&&(S=!0))),i=et(s),r=this._moves({legal:!0,piece:h||i}),!_)return null;for(let d=0,E=r.length;d<E;d++)if(u){if((!h||h.toLowerCase()==r[d].piece)&&C[u]==r[d].from&&C[_]==r[d].to&&(!g||g.toLowerCase()==r[d].promotion))return r[d];if(S){const y=P(r[d].from);if((!h||h.toLowerCase()==r[d].piece)&&C[_]==r[d].to&&(u==y[0]||u==y[1])&&(!g||g.toLowerCase()==r[d].promotion))return r[d]}}else if(s===Ce(this._moveToSan(r[d],r)).replace("x",""))return r[d];return null}ascii(){let t=`   +------------------------+
`;for(let e=C.a8;e<=C.h1;e++){if(Z(e)===0&&(t+=" "+"87654321"[j(e)]+" |"),this._board[e]){const s=this._board[e].type,r=this._board[e].color===M?s.toUpperCase():s.toLowerCase();t+=" "+r+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let r=0,h=e.length;r<h;r++)this._makeMove(e[r]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=C.a8;s<=C.h1;s++)this._board[s]==null?e.push(null):e.push({square:P(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in C){const e=C[t];return(j(e)+Z(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new re(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[I,B])e[i]!==void 0&&(e[i]?this._castling[t]|=ne[i]:this._castling[t]&=~ne[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[I]===void 0||e[I]===s[I])&&(e[B]===void 0||e[B]===s[B])}getCastlingRights(t){return{[I]:(this._castling[t]&ne[I])!==0,[B]:(this._castling[t]&ne[B])!==0}}moveNumber(){return this._moveNumber}}const Ts={w:{p:"https://upload.wikimedia.org/wikipedia/commons/1/10/Chess_plt45.svg",n:"https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg",r:"https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg",q:"https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg",k:"https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg"},b:{p:"https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg",n:"https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg",r:"https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg",q:"https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg",k:"https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg"}};class Ps{constructor(t,e,s){this.boardEl=document.getElementById(t),this.game=e,this.onMove=s,this.selectedSquare=null,this.possibleMoves=[],this.flipped=!1}render(){this.boardEl.innerHTML="";const t=this.game.board();for(let e=0;e<8;e++)for(let s=0;s<8;s++){const i=t[e][s],r=document.createElement("div"),h=String.fromCharCode(97+s)+(8-e),c=(e+s)%2===1;if(r.className=`square ${c?"dark":"light"}`,r.dataset.square=h,this.selectedSquare===h&&r.classList.add("selected"),this.possibleMoves.some(u=>u.to===h)?(r.classList.add("highlight"),r.onclick=()=>this.handleMove(h)):r.onclick=()=>this.handleClick(h),i){const u=document.createElement("div");u.className="piece",u.style.backgroundImage=`url(${Ts[i.color][i.type]})`,r.appendChild(u)}i&&i.type==="k"&&this.game.isCheck()&&i.color===this.game.turn()&&r.classList.add("check"),this.boardEl.appendChild(r)}}handleClick(t){const e=this.game.get(t);e&&e.color===this.game.turn()?this.selectedSquare===t?this.deselect():this.select(t):this.deselect()}select(t){this.selectedSquare=t,this.possibleMoves=this.game.moves({square:t,verbose:!0}),this.render()}deselect(){this.selectedSquare=null,this.possibleMoves=[],this.render()}handleMove(t){const e=this.selectedSquare;this.deselect(),this.onMove(e,t)}}const Ns={p:10,n:30,b:30,r:50,q:90,k:900};function Ms(o){let t=0;const e=o.board();for(let s=0;s<8;s++)for(let i=0;i<8;i++){const r=e[s][i];if(r){const h=Ns[r.type];t+=r.color==="w"?h:-h}}return t}function Os(o,t=3){if(o.isGameOver())return null;let e=null,s=-1/0;const i=o.turn()==="w";s=i?-1/0:1/0;const r=o.moves();r.sort(()=>Math.random()-.5);for(const h of r){o.move(h);const c=ye(o,t-1,-1/0,1/0,!i);o.undo(),i?c>s&&(s=c,e=h):c<s&&(s=c,e=h)}return e}function ye(o,t,e,s,i){if(t===0||o.isGameOver())return Ms(o);const r=o.moves();if(i){let h=-1/0;for(const c of r){o.move(c);const u=ye(o,t-1,e,s,!1);if(o.undo(),h=Math.max(h,u),e=Math.max(e,u),s<=e)break}return h}else{let h=1/0;for(const c of r){o.move(c);const u=ye(o,t-1,e,s,!0);if(o.undo(),h=Math.min(h,u),s=Math.min(s,u),s<=e)break}return h}}const O=new Is,st=document.getElementById("game-status"),oe=document.getElementById("move-list");document.getElementById("captured-white");document.getElementById("captured-black");const J=new Ps("board",O,xs);function xs(o,t){try{if(O.move({from:o,to:t,promotion:"q"})===null)return;J.render(),X(),O.isGameOver()||setTimeout(Ls,250)}catch(e){console.log("Invalid move",e)}}function Ls(){st.textContent="AI is thinking...",setTimeout(()=>{const o=Os(O,3);o&&(O.move(o),J.render(),X())},10)}function X(){let o="";O.isCheckmate()?o=`Game over, ${O.turn()==="w"?"Black":"White"} wins by checkmate!`:O.isDraw()?o="Game over, drawn position":(o=`${O.turn()==="w"?"White":"Black"} to move`,O.inCheck()&&(o+=", "+(O.turn()==="w"?"White":"Black")+" is in check")),st.textContent=o,qs(),Ks()}function qs(){oe.innerHTML="",O.history().forEach((t,e)=>{const s=document.createElement("div");s.className="move-entry",s.textContent=`${Math.floor(e/2)+1}. ${t}`,oe.appendChild(s)}),oe.scrollTop=oe.scrollHeight}function Ks(){const o=O.board().flat().filter(t=>t!==null);o.filter(t=>t.color==="w").map(t=>t.type).sort(),o.filter(t=>t.color==="b").map(t=>t.type).sort()}document.getElementById("reset-btn").addEventListener("click",()=>{O.reset(),J.render(),X()});document.getElementById("undo-btn").addEventListener("click",()=>{O.undo(),O.undo(),J.render(),X()});J.render();X();
